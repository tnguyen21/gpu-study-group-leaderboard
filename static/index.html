<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU Kernel Leaderboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0f0f1a;
            --bg-main: #1a1a2e;
            --bg-editor: #16213e;
            --bg-sidebar: #12122a;
            --accent: #00d9ff;
            --accent-hover: #00b8d4;
            --text: #e0e0e0;
            --text-muted: #8892a0;
            --success: #4ade80;
            --error: #f87171;
            --warning: #fbbf24;
            --border: #2a2a4a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 56px;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--accent);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .username-input {
            background: var(--bg-editor);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text);
            font-size: 0.875rem;
            width: 150px;
        }

        .username-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Main layout */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .problem-list {
            list-style: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .problem-list li {
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 2px;
            transition: background 0.15s;
        }

        .problem-list li:hover {
            background: var(--bg-editor);
        }

        .problem-list li.active {
            background: var(--accent);
            color: var(--bg-dark);
            font-weight: 500;
        }

        .problem-info {
            flex: 1;
            overflow-y: auto;
        }

        .problem-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        .problem-chapter {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .problem-description {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Leaderboard */
        .leaderboard-section {
            padding: 1rem;
            flex-shrink: 0;
        }

        .leaderboard-list {
            list-style: none;
            font-size: 0.8rem;
        }

        .leaderboard-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard-list li:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            color: var(--text-muted);
            width: 24px;
        }

        .leaderboard-rank.gold { color: #ffd700; }
        .leaderboard-rank.silver { color: #c0c0c0; }
        .leaderboard-rank.bronze { color: #cd7f32; }

        .leaderboard-user {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leaderboard-time {
            color: var(--success);
            font-family: monospace;
        }

        /* Editor area */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            background: var(--bg-main);
            border-bottom: 1px solid var(--border);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .editor-tab {
            background: var(--bg-editor);
            border: 1px solid var(--border);
            border-radius: 6px 6px 0 0;
            padding: 0.4rem 1rem;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .editor-tab.active {
            background: var(--bg-editor);
            border-bottom-color: var(--bg-editor);
            color: var(--text);
        }

        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-secondary {
            background: var(--bg-editor);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-dark);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .editor-wrapper {
            flex: 1;
            overflow: hidden;
        }

        .cm-editor {
            height: 100%;
            font-size: 14px;
        }

        .cm-scroller {
            overflow: auto;
        }

        /* Console */
        .console-container {
            height: 180px;
            min-height: 100px;
            background: var(--bg-dark);
            border-top: 1px solid var(--border);
        }

        .console-header {
            background: var(--bg-main);
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-clear {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .console-clear:hover {
            color: var(--text);
        }

        .console-output {
            padding: 0.75rem 1rem;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            overflow-y: auto;
            height: calc(100% - 32px);
        }

        .console-line {
            margin-bottom: 0.25rem;
        }

        .console-line.info { color: var(--text-muted); }
        .console-line.success { color: var(--success); }
        .console-line.error { color: var(--error); }
        .console-line.warning { color: var(--warning); }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--bg-dark);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Empty state */
        .empty-state {
            color: var(--text-muted);
            font-size: 0.875rem;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>GPU Kernel Leaderboard</h1>
        <div class="header-right">
            <label style="font-size: 0.875rem; color: var(--text-muted);">Username:</label>
            <input type="text" id="username" class="username-input" placeholder="anonymous" />
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Problems</h3>
                <ul class="problem-list" id="problem-list">
                    <li class="empty-state">Loading...</li>
                </ul>
            </div>

            <div class="sidebar-section problem-info" id="problem-info">
                <h3>Problem Info</h3>
                <p class="empty-state">Select a problem to view details</p>
            </div>

            <div class="leaderboard-section">
                <h3 style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 0.75rem;">Leaderboard</h3>
                <ul class="leaderboard-list" id="leaderboard-list">
                    <li class="empty-state">Select a problem</li>
                </ul>
            </div>
        </aside>

        <main class="editor-container">
            <div class="editor-header">
                <div class="editor-tabs">
                    <div class="editor-tab active" id="filename-tab">solution.cu</div>
                </div>
                <div class="editor-actions">
                    <button class="btn btn-secondary" id="reset-btn">Reset</button>
                    <button class="btn btn-primary" id="submit-btn" disabled>Submit</button>
                </div>
            </div>

            <div class="editor-wrapper" id="editor"></div>

            <div class="console-container">
                <div class="console-header">
                    <span>Console Output</span>
                    <button class="console-clear" id="clear-console">Clear</button>
                </div>
                <div class="console-output" id="console-output">
                    <div class="console-line info">Select a problem to get started.</div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>

    <script>
        // State
        let problems = [];
        let currentProblem = null;
        let originalStub = '';
        let editor = null;
        let isSubmitting = false;

        // DOM elements
        const problemList = document.getElementById('problem-list');
        const problemInfo = document.getElementById('problem-info');
        const leaderboardList = document.getElementById('leaderboard-list');
        const editorContainer = document.getElementById('editor');
        const consoleOutput = document.getElementById('console-output');
        const submitBtn = document.getElementById('submit-btn');
        const resetBtn = document.getElementById('reset-btn');
        const usernameInput = document.getElementById('username');
        const filenameTab = document.getElementById('filename-tab');
        const clearConsoleBtn = document.getElementById('clear-console');

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            // Define CUDA as an extension of C++
            monaco.languages.register({ id: 'cuda' });
            monaco.languages.setMonarchTokensProvider('cuda', {
                defaultToken: '',
                tokenPostfix: '.cu',
                keywords: [
                    '__global__', '__device__', '__host__', '__shared__', '__constant__',
                    'threadIdx', 'blockIdx', 'blockDim', 'gridDim', 'warpSize',
                    '__syncthreads', '__syncwarp', 'atomicAdd', 'atomicSub', 'atomicMax', 'atomicMin',
                    'atomicExch', 'atomicCAS', '__ldg', '__shfl_sync', '__shfl_down_sync',
                    'cudaMalloc', 'cudaFree', 'cudaMemcpy', 'cudaMemset', 'cudaDeviceSynchronize',
                    'dim3', 'float4', 'float2', 'int4', 'int2', 'uint4', 'uint2',
                    'auto', 'break', 'case', 'catch', 'class', 'const', 'continue',
                    'default', 'delete', 'do', 'else', 'enum', 'explicit', 'extern',
                    'false', 'for', 'friend', 'goto', 'if', 'inline', 'mutable',
                    'namespace', 'new', 'operator', 'private', 'protected', 'public',
                    'register', 'return', 'sizeof', 'static', 'struct', 'switch',
                    'template', 'this', 'throw', 'true', 'try', 'typedef', 'typename',
                    'union', 'unsigned', 'virtual', 'void', 'volatile', 'while'
                ],
                typeKeywords: [
                    'bool', 'char', 'double', 'float', 'int', 'long', 'short', 'signed',
                    'size_t', 'unsigned', 'void', 'wchar_t'
                ],
                operators: [
                    '=', '>', '<', '!', '~', '?', ':', '==', '<=', '>=', '!=',
                    '&&', '||', '++', '--', '+', '-', '*', '/', '&', '|', '^', '%',
                    '<<', '>>', '>>>', '+=', '-=', '*=', '/=', '&=', '|=', '^=',
                    '%=', '<<=', '>>=', '>>>='
                ],
                symbols: /[=><!~?:&|+\-*\/\^%]+/,
                escapes: /\\(?:[abfnrtv\\"']|x[0-9A-Fa-f]{1,4}|u[0-9A-Fa-f]{4}|U[0-9A-Fa-f]{8})/,
                tokenizer: {
                    root: [
                        [/[a-z_$][\w$]*/, {
                            cases: {
                                '@typeKeywords': 'keyword.type',
                                '@keywords': 'keyword',
                                '@default': 'identifier'
                            }
                        }],
                        [/[A-Z][\w\$]*/, 'type.identifier'],
                        { include: '@whitespace' },
                        [/[{}()\[\]]/, '@brackets'],
                        [/[<>](?!@symbols)/, '@brackets'],
                        [/@symbols/, {
                            cases: {
                                '@operators': 'operator',
                                '@default': ''
                            }
                        }],
                        [/\d*\.\d+([eE][\-+]?\d+)?[fFdD]?/, 'number.float'],
                        [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                        [/\d+/, 'number'],
                        [/[;,.]/, 'delimiter'],
                        [/"([^"\\]|\\.)*$/, 'string.invalid'],
                        [/"/, 'string', '@string'],
                        [/'[^\\']'/, 'string'],
                        [/(')(@escapes)(')/, ['string', 'string.escape', 'string']],
                        [/'/, 'string.invalid']
                    ],
                    whitespace: [
                        [/[ \t\r\n]+/, 'white'],
                        [/\/\*/, 'comment', '@comment'],
                        [/\/\/.*$/, 'comment']
                    ],
                    comment: [
                        [/[^\/*]+/, 'comment'],
                        [/\/\*/, 'comment', '@push'],
                        [/\*\//, 'comment', '@pop'],
                        [/[\/*]/, 'comment']
                    ],
                    string: [
                        [/[^\\"]+/, 'string'],
                        [/@escapes/, 'string.escape'],
                        [/\\./, 'string.escape.invalid'],
                        [/"/, 'string', '@pop']
                    ]
                }
            });

            // Create editor
            editor = monaco.editor.create(editorContainer, {
                value: '// Select a problem from the sidebar to get started\n',
                language: 'cuda',
                theme: 'vs-dark',
                fontSize: 14,
                fontFamily: "'Fira Code', 'Cascadia Code', 'JetBrains Mono', Menlo, Monaco, monospace",
                fontLigatures: true,
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                tabSize: 4,
                insertSpaces: true,
                lineNumbers: 'on',
                renderLineHighlight: 'line',
                cursorBlinking: 'smooth',
                smoothScrolling: true,
                padding: { top: 10, bottom: 10 }
            });

            // Initialize app after editor is ready
            init();
        });

        // Initialize app
        async function init() {
            // Load username from localStorage
            const savedUsername = localStorage.getItem('leaderboard_username');
            if (savedUsername) {
                usernameInput.value = savedUsername;
            }

            // Save username on change
            usernameInput.addEventListener('change', () => {
                localStorage.setItem('leaderboard_username', usernameInput.value);
            });

            // Load problems
            await loadProblems();

            // Event listeners
            submitBtn.addEventListener('click', handleSubmit);
            resetBtn.addEventListener('click', handleReset);
            clearConsoleBtn.addEventListener('click', clearConsole);
        }

        // API helpers
        function buildUrl(endpointWithParams) {
            // Split endpoint and query string: "leaderboard?problem_id=x" -> ["leaderboard", "problem_id=x"]
            const [endpoint, queryString] = endpointWithParams.split('?');
            const query = queryString ? `?${queryString}` : '';

            const host = window.location.host;
            if (host.includes('modal.run')) {
                // Modal format: "workspace--kernel-leaderboard-index.modal.run"
                // We need: "workspace--kernel-leaderboard-{endpoint}.modal.run?query"
                const match = host.match(/^(.+--kernel-leaderboard)-\w+\.modal\.run$/);
                if (match) {
                    return `https://${match[1]}-${endpoint}.modal.run${query}`;
                }
            }
            // Local development - assume same origin
            return `/${endpoint}${query}`;
        }

        async function fetchApi(endpoint, options = {}) {
            const url = buildUrl(endpoint);
            console.log(`Fetching: ${url}`);
            const response = await fetch(url, options);
            return response.json();
        }

        async function loadProblems() {
            try {
                const data = await fetchApi('problems');
                problems = data.problems || [];
                renderProblemList();

                // Select first problem by default
                if (problems.length > 0) {
                    selectProblem(problems[0].id);
                }
            } catch (error) {
                log('Failed to load problems: ' + error.message, 'error');
                problemList.innerHTML = '<li class="empty-state">Failed to load problems</li>';
            }
        }

        function renderProblemList() {
            problemList.innerHTML = problems.map(p => `
                <li data-id="${p.id}" class="${currentProblem?.id === p.id ? 'active' : ''}">
                    ${p.name}
                </li>
            `).join('');

            // Add click handlers
            problemList.querySelectorAll('li').forEach(li => {
                li.addEventListener('click', () => {
                    selectProblem(li.dataset.id);
                });
            });
        }

        async function selectProblem(problemId) {
            const problem = problems.find(p => p.id === problemId);
            if (!problem) return;

            currentProblem = problem;
            renderProblemList();
            filenameTab.textContent = `${problemId}.cu`;
            submitBtn.disabled = false;

            // Load stub
            try {
                const data = await fetchApi(`stub?problem_id=${problemId}`);
                if (data.stub) {
                    originalStub = data.stub;
                    setEditorContent(data.stub);

                    // Parse and display problem info
                    renderProblemInfo(data.stub);
                } else {
                    log('Failed to load stub: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Failed to load stub: ' + error.message, 'error');
            }

            // Load leaderboard
            await loadLeaderboard(problemId);
        }

        function renderProblemInfo(stubContent) {
            // Parse comment block from stub
            const commentMatch = stubContent.match(/\/\*\s*([\s\S]*?)\*\//);
            if (!commentMatch) {
                problemInfo.innerHTML = `
                    <h3>Problem Info</h3>
                    <div class="problem-name">${currentProblem.name}</div>
                `;
                return;
            }

            const comment = commentMatch[1];
            const lines = comment.split('\n').map(l => l.replace(/^\s*\*\s?/, '').trim());

            // Extract parts
            let name = currentProblem.name;
            let chapter = '';
            let description = [];
            let inDescription = false;

            for (const line of lines) {
                if (line.startsWith('Problem:')) {
                    name = line.replace('Problem:', '').trim();
                } else if (line.startsWith('PMPP')) {
                    chapter = line;
                } else if (line && !line.startsWith('Input:') && !line.startsWith('Output:') &&
                           !line.startsWith('Key concepts:') && !line.startsWith('Optimization')) {
                    description.push(line);
                }
            }

            problemInfo.innerHTML = `
                <h3>Problem Info</h3>
                <div class="problem-name">${name}</div>
                ${chapter ? `<div class="problem-chapter">${chapter}</div>` : ''}
                <div class="problem-description">${description.slice(0, 5).join('\n')}</div>
            `;
        }

        async function loadLeaderboard(problemId) {
            try {
                const data = await fetchApi(`leaderboard?problem_id=${problemId}`);
                const rankings = data.rankings || [];

                if (rankings.length === 0) {
                    leaderboardList.innerHTML = '<li class="empty-state">No submissions yet</li>';
                    return;
                }

                leaderboardList.innerHTML = rankings.slice(0, 10).map((r, i) => {
                    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                    return `
                        <li>
                            <span class="leaderboard-rank ${rankClass}">${r.rank}.</span>
                            <span class="leaderboard-user">${r.user_id}</span>
                            <span class="leaderboard-time">${r.best_time_ms.toFixed(4)}ms</span>
                        </li>
                    `;
                }).join('');
            } catch (error) {
                leaderboardList.innerHTML = '<li class="empty-state">Failed to load</li>';
            }
        }

        function setEditorContent(content) {
            editor.setValue(content);
        }

        function getEditorContent() {
            return editor.getValue();
        }

        async function handleSubmit() {
            if (!currentProblem || isSubmitting) return;

            const username = usernameInput.value.trim() || 'anonymous';
            const kernelSource = getEditorContent();

            if (!kernelSource.trim()) {
                log('Error: No code to submit', 'error');
                return;
            }

            isSubmitting = true;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span>Submitting...';

            log(`Submitting to ${currentProblem.id} as "${username}"...`, 'info');

            try {
                const result = await fetchApi('submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        problem_id: currentProblem.id,
                        user_id: username,
                        kernel_source: kernelSource
                    })
                });

                if (result.success) {
                    log(`Success! Median time: ${result.time_ms.toFixed(4)} ms`, 'success');
                    log(`All runs: ${result.times.map(t => t.toFixed(4)).join(', ')} ms`, 'info');
                    log(`Kernel hash: ${result.kernel_hash}`, 'info');

                    // Refresh leaderboard
                    await loadLeaderboard(currentProblem.id);
                } else {
                    log(`Submission failed: ${result.error}`, 'error');
                    if (result.message) {
                        // Format compilation errors nicely
                        const msg = result.message;
                        if (msg.includes('error:')) {
                            msg.split('\n').forEach(line => {
                                if (line.trim()) log(line, 'error');
                            });
                        } else {
                            log(result.message, 'error');
                        }
                    }
                }
            } catch (error) {
                log('Network error: ' + error.message, 'error');
            } finally {
                isSubmitting = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        }

        function handleReset() {
            if (originalStub) {
                setEditorContent(originalStub);
                log('Editor reset to original stub', 'info');
            }
        }

        function log(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `> ${message}`;
            consoleOutput.appendChild(line);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        function clearConsole() {
            consoleOutput.innerHTML = '';
        }

        // App is started inside the require() callback after Monaco loads
    </script>
</body>
</html>
